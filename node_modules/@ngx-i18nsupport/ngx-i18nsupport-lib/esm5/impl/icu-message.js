/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { format, isNullOrUndefined, isString } from 'util';
var MessageCategory = /** @class */ (function () {
    function MessageCategory(_category, _message) {
        this._category = _category;
        this._message = _message;
    }
    /**
     * @return {?}
     */
    MessageCategory.prototype.getCategory = /**
     * @return {?}
     */
    function () {
        return this._category;
    };
    /**
     * @return {?}
     */
    MessageCategory.prototype.getMessageNormalized = /**
     * @return {?}
     */
    function () {
        return this._message;
    };
    return MessageCategory;
}());
if (false) {
    /** @type {?} */
    MessageCategory.prototype._category;
    /** @type {?} */
    MessageCategory.prototype._message;
}
/**
 * Implementation of an ICU Message.
 * Created by martin on 05.06.2017.
 */
var /**
 * Implementation of an ICU Message.
 * Created by martin on 05.06.2017.
 */
ICUMessage = /** @class */ (function () {
    function ICUMessage(_parser, isPluralMessage) {
        this._parser = _parser;
        this._isPluralMessage = isPluralMessage;
        this._categories = [];
    }
    /**
     * @param {?} category
     * @param {?} message
     * @return {?}
     */
    ICUMessage.prototype.addCategory = /**
     * @param {?} category
     * @param {?} message
     * @return {?}
     */
    function (category, message) {
        this._categories.push(new MessageCategory(category, message));
    };
    /**
     * ICU message as native string.
     * This is, how it is stored, something like '{x, plural, =0 {..}'
     * @return {?} ICU message as native string.
     */
    ICUMessage.prototype.asNativeString = /**
     * ICU message as native string.
     * This is, how it is stored, something like '{x, plural, =0 {..}'
     * @return {?} ICU message as native string.
     */
    function () {
        /** @type {?} */
        var varname = (this.isPluralMessage()) ? 'VAR_PLURAL' : 'VAR_SELECT';
        /** @type {?} */
        var type = (this.isPluralMessage()) ? 'plural' : 'select';
        /** @type {?} */
        var choiceString = '';
        this._categories.forEach(function (category) {
            choiceString = choiceString + format(' %s {%s}', category.getCategory(), category.getMessageNormalized().asNativeString());
        });
        return format('{%s, %s,%s}', varname, type, choiceString);
    };
    /**
     * Is it a plural message?
     */
    /**
     * Is it a plural message?
     * @return {?}
     */
    ICUMessage.prototype.isPluralMessage = /**
     * Is it a plural message?
     * @return {?}
     */
    function () {
        return this._isPluralMessage;
    };
    /**
     * Is it a select message?
     */
    /**
     * Is it a select message?
     * @return {?}
     */
    ICUMessage.prototype.isSelectMessage = /**
     * Is it a select message?
     * @return {?}
     */
    function () {
        return !this._isPluralMessage;
    };
    /**
     * All the parts of the message.
     * E.g. the ICU message {wolves, plural, =0 {no wolves} =1 {one wolf} =2 {two wolves} other {a wolf pack}}
     * has 4 category objects with the categories =0, =1, =2, other.
     */
    /**
     * All the parts of the message.
     * E.g. the ICU message {wolves, plural, =0 {no wolves} =1 {one wolf} =2 {two wolves} other {a wolf pack}}
     * has 4 category objects with the categories =0, =1, =2, other.
     * @return {?}
     */
    ICUMessage.prototype.getCategories = /**
     * All the parts of the message.
     * E.g. the ICU message {wolves, plural, =0 {no wolves} =1 {one wolf} =2 {two wolves} other {a wolf pack}}
     * has 4 category objects with the categories =0, =1, =2, other.
     * @return {?}
     */
    function () {
        return this._categories;
    };
    /**
     * Translate message and return a new, translated message
     * @param translation the translation (hashmap of categories and translations).
     * @return new message wit translated content.
     * @throws an error if translation does not match the message.
     * This is the case, if there are categories not contained in the original message.
     */
    /**
     * Translate message and return a new, translated message
     * @throws an error if translation does not match the message.
     * This is the case, if there are categories not contained in the original message.
     * @param {?} translation the translation (hashmap of categories and translations).
     * @return {?} new message wit translated content.
     */
    ICUMessage.prototype.translate = /**
     * Translate message and return a new, translated message
     * @throws an error if translation does not match the message.
     * This is the case, if there are categories not contained in the original message.
     * @param {?} translation the translation (hashmap of categories and translations).
     * @return {?} new message wit translated content.
     */
    function (translation) {
        var _this = this;
        /** @type {?} */
        var message = new ICUMessage(this._parser, this.isPluralMessage());
        /** @type {?} */
        var translatedCategories = new Set();
        this._categories.forEach(function (category) {
            /** @type {?} */
            var translatedMessage;
            /** @type {?} */
            var translationForCategory = translation[category.getCategory()];
            if (isNullOrUndefined(translationForCategory)) {
                translatedMessage = category.getMessageNormalized();
            }
            else if (isString(translationForCategory)) {
                translatedCategories.add(category.getCategory());
                translatedMessage = _this._parser.parseNormalizedString(/** @type {?} */ (translationForCategory), null);
            }
            else {
                // TODO embedded ICU Message
                translatedMessage = null;
            }
            message.addCategory(category.getCategory(), translatedMessage);
        });
        // new categories, which are not part of the original message
        Object.keys(translation).forEach(function (categoryName) {
            if (!translatedCategories.has(categoryName)) {
                if (_this.isSelectMessage()) {
                    throw new Error(format('adding a new category not allowed for select messages ("%s" is not part of message)', categoryName));
                }
                else {
                    _this.checkValidPluralCategory(categoryName);
                    /** @type {?} */
                    var translatedMessage = _this._parser.parseNormalizedString(/** @type {?} */ (translation[categoryName]), null);
                    message.addCategory(categoryName, translatedMessage);
                }
            }
        });
        return message;
    };
    /**
     * Check, wether category is valid plural category.
     * Allowed are =n, 'zero', 'one', 'two', 'few', 'many' and 'other'
     * @throws an error, if it is not a valid category name
     * @param {?} categoryName category
     * @return {?}
     */
    ICUMessage.prototype.checkValidPluralCategory = /**
     * Check, wether category is valid plural category.
     * Allowed are =n, 'zero', 'one', 'two', 'few', 'many' and 'other'
     * @throws an error, if it is not a valid category name
     * @param {?} categoryName category
     * @return {?}
     */
    function (categoryName) {
        /** @type {?} */
        var allowedKeywords = ['zero', 'one', 'two', 'few', 'many', 'other'];
        if (categoryName.match(/=\d+/)) {
            return;
        }
        if (allowedKeywords.find(function (key) { return key === categoryName; })) {
            return;
        }
        throw new Error(format('invalid plural category "%s", allowed are =<n> and %s', categoryName, allowedKeywords));
    };
    return ICUMessage;
}());
/**
 * Implementation of an ICU Message.
 * Created by martin on 05.06.2017.
 */
export { ICUMessage };
if (false) {
    /** @type {?} */
    ICUMessage.prototype._isPluralMessage;
    /** @type {?} */
    ICUMessage.prototype._categories;
    /** @type {?} */
    ICUMessage.prototype._parser;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWN1LW1lc3NhZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LWkxOG5zdXBwb3J0L25neC1pMThuc3VwcG9ydC1saWIvIiwic291cmNlcyI6WyJpbXBsL2ljdS1tZXNzYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUMsTUFBTSxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUd6RCxJQUFBO0lBRUkseUJBQW9CLFNBQWlCLEVBQVUsUUFBNEI7UUFBdkQsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQW9CO0tBQUk7Ozs7SUFFeEUscUNBQVc7Ozs7UUFDZCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7Ozs7O0lBR25CLDhDQUFvQjs7OztRQUN2QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7OzBCQWI3QjtJQWVDLENBQUE7Ozs7Ozs7Ozs7O0FBTUQ7Ozs7QUFBQTtJQU1JLG9CQUFvQixPQUF1QixFQUFFLGVBQXdCO1FBQWpELFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7UUFDeEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7S0FDekI7Ozs7OztJQUVELGdDQUFXOzs7OztJQUFYLFVBQVksUUFBZ0IsRUFBRSxPQUEyQjtRQUNyRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLGVBQWUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUNqRTs7Ozs7O0lBT00sbUNBQWM7Ozs7Ozs7UUFDakIsSUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUM7O1FBQ3ZFLElBQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMs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Q2pELElBQU0sZUFBZSxHQUFHLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN2RSxJQUFJLFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDNUIsT0FBTztTQUNWO1FBQ0QsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLFVBQUMsR0FBRyxJQUFLLE9BQUEsR0FBRyxLQUFLLFlBQVksRUFBcEIsQ0FBb0IsQ0FBQyxFQUFFO1lBQ3JELE9BQU87U0FDVjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLHVEQUF1RCxFQUFFLFlBQVksRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDOztxQkFqSXhIO0lBbUlDLENBQUE7Ozs7O0FBOUdELHNCQThHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SUlDVU1lc3NhZ2UsIElJQ1VNZXNzYWdlQ2F0ZWdvcnksIElJQ1VNZXNzYWdlVHJhbnNsYXRpb24sIElOb3JtYWxpemVkTWVzc2FnZX0gZnJvbSAnLi4vYXBpL2luZGV4JztcclxuaW1wb3J0IHtmb3JtYXQsIGlzTnVsbE9yVW5kZWZpbmVkLCBpc1N0cmluZ30gZnJvbSAndXRpbCc7XHJcbmltcG9ydCB7SU1lc3NhZ2VQYXJzZXJ9IGZyb20gJy4vaS1tZXNzYWdlLXBhcnNlcic7XHJcblxyXG5jbGFzcyBNZXNzYWdlQ2F0ZWdvcnkgaW1wbGVtZW50cyBJSUNVTWVzc2FnZUNhdGVnb3J5IHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jYXRlZ29yeTogc3RyaW5nLCBwcml2YXRlIF9tZXNzYWdlOiBJTm9ybWFsaXplZE1lc3NhZ2UpIHt9XHJcblxyXG4gICAgcHVibGljIGdldENhdGVnb3J5KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NhdGVnb3J5O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRNZXNzYWdlTm9ybWFsaXplZCgpOiBJTm9ybWFsaXplZE1lc3NhZ2Uge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9tZXNzYWdlO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogSW1wbGVtZW50YXRpb24gb2YgYW4gSUNVIE1lc3NhZ2UuXHJcbiAqIENyZWF0ZWQgYnkgbWFydGluIG9uIDA1LjA2LjIwMTcuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgSUNVTWVzc2FnZSBpbXBsZW1lbnRzIElJQ1VNZXNzYWdlIHtcclxuXHJcbiAgICBwcml2YXRlIF9pc1BsdXJhbE1lc3NhZ2U6IGJvb2xlYW47XHJcblxyXG4gICAgcHJpdmF0ZSBfY2F0ZWdvcmllczogSUlDVU1lc3NhZ2VDYXRlZ29yeVtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX3BhcnNlcjogSU1lc3NhZ2VQYXJzZXIsIGlzUGx1cmFsTWVzc2FnZTogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMuX2lzUGx1cmFsTWVzc2FnZSA9IGlzUGx1cmFsTWVzc2FnZTtcclxuICAgICAgICB0aGlzLl9jYXRlZ29yaWVzID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgYWRkQ2F0ZWdvcnkoY2F0ZWdvcnk6IHN0cmluZywgbWVzc2FnZTogSU5vcm1hbGl6ZWRNZXNzYWdlKSB7XHJcbiAgICAgICAgdGhpcy5fY2F0ZWdvcmllcy5wdXNoKG5ldyBNZXNzYWdlQ2F0ZWdvcnkoY2F0ZWdvcnksIG1lc3NhZ2UpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIElDVSBtZXNzYWdlIGFzIG5hdGl2ZSBzdHJpbmcuXHJcbiAgICAgKiBUaGlzIGlzLCBob3cgaXQgaXMgc3RvcmVkLCBzb21ldGhpbmcgbGlrZSAne3gsIHBsdXJhbCwgPTAgey4ufSdcclxuICAgICAqIEByZXR1cm4gSUNVIG1lc3NhZ2UgYXMgbmF0aXZlIHN0cmluZy5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzTmF0aXZlU3RyaW5nKCk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgdmFybmFtZSA9ICh0aGlzLmlzUGx1cmFsTWVzc2FnZSgpKSA/ICdWQVJfUExVUkFMJyA6ICdWQVJfU0VMRUNUJztcclxuICAgICAgICBjb25zdCB0eXBlID0gKHRoaXMuaXNQbHVyYWxNZXNzYWdlKCkpID8gJ3BsdXJhbCcgOiAnc2VsZWN0JztcclxuICAgICAgICBsZXQgY2hvaWNlU3RyaW5nID0gJyc7XHJcbiAgICAgICAgdGhpcy5fY2F0ZWdvcmllcy5mb3JFYWNoKChjYXRlZ29yeTogSUlDVU1lc3NhZ2VDYXRlZ29yeSkgPT4ge1xyXG4gICAgICAgICAgICBjaG9pY2VTdHJpbmcgPSBjaG9pY2VTdHJpbmcgKyBmb3JtYXQoJyAlcyB7JXN9JywgY2F0ZWdvcnkuZ2V0Q2F0ZWdvcnkoKSwgY2F0ZWdvcnkuZ2V0TWVzc2FnZU5vcm1hbGl6ZWQoKS5hc05hdGl2ZVN0cmluZygpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZm9ybWF0KCd7JXMsICVzLCVzfScsIHZhcm5hbWUsIHR5cGUsIGNob2ljZVN0cmluZyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJcyBpdCBhIHBsdXJhbCBtZXNzYWdlP1xyXG4gICAgICovXHJcbiAgICBpc1BsdXJhbE1lc3NhZ2UoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzUGx1cmFsTWVzc2FnZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIElzIGl0IGEgc2VsZWN0IG1lc3NhZ2U/XHJcbiAgICAgKi9cclxuICAgIGlzU2VsZWN0TWVzc2FnZSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gIXRoaXMuX2lzUGx1cmFsTWVzc2FnZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFsbCB0aGUgcGFydHMgb2YgdGhlIG1lc3NhZ2UuXHJcbiAgICAgKiBFLmcuIHRoZSBJQ1UgbWVzc2FnZSB7d29sdmVzLCBwbHVyYWwsID0wIHtubyB3b2x2ZXN9ID0xIHtvbmUgd29sZn0gPTIge3R3byB3b2x2ZXN9IG90aGVyIHthIHdvbGYgcGFja319XHJcbiAgICAgKiBoYXMgNCBjYXRlZ29yeSBvYmplY3RzIHdpdGggdGhlIGNhdGVnb3JpZXMgPTAsID0xLCA9Miwgb3RoZXIuXHJcbiAgICAgKi9cclxuICAgIGdldENhdGVnb3JpZXMoKTogSUlDVU1lc3NhZ2VDYXRlZ29yeVtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY2F0ZWdvcmllcztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFRyYW5zbGF0ZSBtZXNzYWdlIGFuZCByZXR1cm4gYSBuZXcsIHRyYW5zbGF0ZWQgbWVzc2FnZVxyXG4gICAgICogQHBhcmFtIHRyYW5zbGF0aW9uIHRoZSB0cmFuc2xhdGlvbiAoaGFzaG1hcCBvZiBjYXRlZ29yaWVzIGFuZCB0cmFuc2xhdGlvbnMpLlxyXG4gICAgICogQHJldHVybiBuZXcgbWVzc2FnZSB3aXQgdHJhbnNsYXRlZCBjb250ZW50LlxyXG4gICAgICogQHRocm93cyBhbiBlcnJvciBpZiB0cmFuc2xhdGlvbiBkb2VzIG5vdCBtYXRjaCB0aGUgbWVzc2FnZS5cclxuICAgICAqIFRoaXMgaXMgdGhlIGNhc2UsIGlmIHRoZXJlIGFyZSBjYXRlZ29yaWVzIG5vdCBjb250YWluZWQgaW4gdGhlIG9yaWdpbmFsIG1lc3NhZ2UuXHJcbiAgICAgKi9cclxuICAgIHRyYW5zbGF0ZSh0cmFuc2xhdGlvbjogSUlDVU1lc3NhZ2VUcmFuc2xhdGlvbik6IElJQ1VNZXNzYWdlIHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gbmV3IElDVU1lc3NhZ2UodGhpcy5fcGFyc2VyLCB0aGlzLmlzUGx1cmFsTWVzc2FnZSgpKTtcclxuICAgICAgICBjb25zdCB0cmFuc2xhdGVkQ2F0ZWdvcmllczogU2V0PHN0cmluZz4gPSBuZXcgU2V0PHN0cmluZz4oKTtcclxuICAgICAgICB0aGlzLl9jYXRlZ29yaWVzLmZvckVhY2goKGNhdGVnb3J5KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCB0cmFuc2xhdGVkTWVzc2FnZTogSU5vcm1hbGl6ZWRNZXNzYWdlO1xyXG4gICAgICAgICAgICBjb25zdCB0cmFuc2xhdGlvbkZvckNhdGVnb3J5OiBzdHJpbmd8SUlDVU1lc3NhZ2VUcmFuc2xhdGlvbiA9IHRyYW5zbGF0aW9uW2NhdGVnb3J5LmdldENhdGVnb3J5KCldO1xyXG4gICAgICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZmluZWQodHJhbnNsYXRpb25Gb3JDYXRlZ29yeSkpIHtcclxuICAgICAgICAgICAgICAgIHRyYW5zbGF0ZWRNZXNzYWdlID0gY2F0ZWdvcnkuZ2V0TWVzc2FnZU5vcm1hbGl6ZWQoKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N0cmluZyh0cmFuc2xhdGlvbkZvckNhdGVnb3J5KSkge1xyXG4gICAgICAgICAgICAgICAgdHJhbnNsYXRlZENhdGVnb3JpZXMuYWRkKGNhdGVnb3J5LmdldENhdGVnb3J5KCkpO1xyXG4gICAgICAgICAgICAgICAgdHJhbnNsYXRlZE1lc3NhZ2UgPSB0aGlzLl9wYXJzZXIucGFyc2VOb3JtYWxpemVkU3RyaW5nKDxzdHJpbmc+IHRyYW5zbGF0aW9uRm9yQ2F0ZWdvcnksIG51bGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETyBlbWJlZGRlZCBJQ1UgTWVzc2FnZVxyXG4gICAgICAgICAgICAgICAgdHJhbnNsYXRlZE1lc3NhZ2UgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG1lc3NhZ2UuYWRkQ2F0ZWdvcnkoY2F0ZWdvcnkuZ2V0Q2F0ZWdvcnkoKSwgdHJhbnNsYXRlZE1lc3NhZ2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIG5ldyBjYXRlZ29yaWVzLCB3aGljaCBhcmUgbm90IHBhcnQgb2YgdGhlIG9yaWdpbmFsIG1lc3NhZ2VcclxuICAgICAgICBPYmplY3Qua2V5cyh0cmFuc2xhdGlvbikuZm9yRWFjaCgoY2F0ZWdvcnlOYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghdHJhbnNsYXRlZENhdGVnb3JpZXMuaGFzKGNhdGVnb3J5TmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU2VsZWN0TWVzc2FnZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZvcm1hdCgnYWRkaW5nIGEgbmV3IGNhdGVnb3J5IG5vdCBhbGxvd2VkIGZvciBzZWxlY3QgbWVzc2FnZXMgKFwiJXNcIiBpcyBub3QgcGFydCBvZiBtZXNzYWdlKScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5TmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrVmFsaWRQbHVyYWxDYXRlZ29yeShjYXRlZ29yeU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE8gZW1iZWRkZWQgSUNVIE1lc3NhZ2VcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdHJhbnNsYXRlZE1lc3NhZ2UgPSB0aGlzLl9wYXJzZXIucGFyc2VOb3JtYWxpemVkU3RyaW5nKDxzdHJpbmc+IHRyYW5zbGF0aW9uW2NhdGVnb3J5TmFtZV0sIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWRkQ2F0ZWdvcnkoY2F0ZWdvcnlOYW1lLCB0cmFuc2xhdGVkTWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbWVzc2FnZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrLCB3ZXRoZXIgY2F0ZWdvcnkgaXMgdmFsaWQgcGx1cmFsIGNhdGVnb3J5LlxyXG4gICAgICogQWxsb3dlZCBhcmUgPW4sICd6ZXJvJywgJ29uZScsICd0d28nLCAnZmV3JywgJ21hbnknIGFuZCAnb3RoZXInXHJcbiAgICAgKiBAcGFyYW0gY2F0ZWdvcnlOYW1lIGNhdGVnb3J5XHJcbiAgICAgKiBAdGhyb3dzIGFuIGVycm9yLCBpZiBpdCBpcyBub3QgYSB2YWxpZCBjYXRlZ29yeSBuYW1lXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY2hlY2tWYWxpZFBsdXJhbENhdGVnb3J5KGNhdGVnb3J5TmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgYWxsb3dlZEtleXdvcmRzID0gWyd6ZXJvJywgJ29uZScsICd0d28nLCAnZmV3JywgJ21hbnknLCAnb3RoZXInXTtcclxuICAgICAgICBpZiAoY2F0ZWdvcnlOYW1lLm1hdGNoKC89XFxkKy8pKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFsbG93ZWRLZXl3b3Jkcy5maW5kKChrZXkpID0+IGtleSA9PT0gY2F0ZWdvcnlOYW1lKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihmb3JtYXQoJ2ludmFsaWQgcGx1cmFsIGNhdGVnb3J5IFwiJXNcIiwgYWxsb3dlZCBhcmUgPTxuPiBhbmQgJXMnLCBjYXRlZ29yeU5hbWUsIGFsbG93ZWRLZXl3b3JkcykpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==